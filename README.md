# SQL/JSON-Query Example Application
This example application generates and exercises SQL and matching result types for nested data queries
defined at

```query-gen/queries/query-specs.ts```

## Setup

- Install dependencies for the app and for the query-generation sub-project:
  ```
  npm i                 # (for the example app)
  cd query-gen && npm i # (for the query generator)
  ```

- Next initialize the example (Postgres) database as described in `db`.
  
  If Docker is installed, this may be as easy as just doing:
  ```
  npm run start-db
  ```
  Or you can setup the example database manually as described in `db/pg-manual-setup.md`.

## Running the example app
  ```
  npm run app
  ```
  This should generate the SQL and matching result types, then compile and run the app.

You should output describing queries and updates made against the database, followed by a notice
that all changes were rolled back.

## Notes about SQL/JSON-Query usage

The build process is configured to automatically generate the app's SQL and result types source code
whenever the app is run via `npm run app`. The queries and sources are generated based on the contents
of `query-gen/queries/query-specs.ts`, and database metadata defined at `query-gen/dbmd/dbmd.json`.
The database metadata is already provided in the example and so doesn't need to be generated in order
to generate queries. However, it may be helpful to see how to perform these steps manually as part of
the build, such as to incorporate them into another project.

### Database Metadata Generation

The database metadata must be generated first before any queries can be generated, but only needs to
be refreshed when the database has changes that need to be incorporated into the app. The database
metadata can be generated at the proper location (`query-gen/dbmd/dbmd.json`) by the provided npm run
script by running `npm run gen-dbmd`. This executes the maven command:

```
# npm run gen-dbmd
mvn -f query-gen/dbmd/pom.xml compile exec:java -DjdbcProps=db/jdbc.props -Ddb=pg
```

Here `db/jdbc.props` is the jdbc connection information for the database from which metadata is gathered.

### Result Types Source Code Generation

The result types for the queries are generated by the `gen-queries-ts` and `gen-queries-java` npm run
scripts. Only the TypeScript results module is actually used in the example application, the Java
generation is only provided as an example.

The TypeScript source generator calls a run-script defined within `query-gen/package.json`, passing it
the output directories for our project.  Note that the paths are relative to the `query-gen` directory
which is why a leading `..` is needed to prefix the output paths.

```
# npm run gen-queries-ts
npm run --prefix query-gen generate-queries -- \
  --sqlDir=../src/generated/sql \
  --tsQueriesDir=../src/generated/lib \
  --tsRelMdsDir=../src/generated/lib
```
